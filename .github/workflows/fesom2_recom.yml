
name: "FESOM2: REcoM Biogeochemistry"
# Controls when the action will run. Triggers the workflow on push or pull request.
on:
  workflow_dispatch: {}
  push:
    branches:
      - fesom2.6_recom_tra_diags
  pull_request:
    types:
      - opened
      - synchronize
      - reopened
    branches:
      - main
# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  general_test:
    # Containers must run in Linux based operating systems
    runs-on: ubuntu-latest
    # Docker Hub image that `container-job` executes in
    container: ghcr.io/fesom/fesom2_docker:fesom2_test_refactoring-master

    # Service containers to run with `gfortran_ubuntu`
    steps:
      # NK: this changes working directory to fesom2
      - uses: actions/checkout@v2

      - name: Git safe directory
        run: |
          git config --global --add safe.directory ${PWD}

      - name: Compile model with REcoM
        run: |
          ./configure.sh ubuntu -DRECOM_COUPLED=ON

      - name: Create REcoM test run
        run: |
          mkrun recom test_pi_recom -m docker
      
      - name: Add REcoM namelists and input files
        run: |
          # Copy default REcoM namelists from config (using simpler 2p1z1d for faster CI)
          cp config/bin_2p1z1d/namelist.recom work_recom/
          cp config/bin_2p1z1d/namelist.tra work_recom/
          
          # Patch file paths in namelists to use local files
          cd work_recom
          sed -i "s|/albedo/work/.*/DustClim.*\.nc|DustClimMonthlyAlbani_pimesh.nc|g" namelist.recom
          sed -i "s|/albedo/work/.*/MonthlyAtmCO2.*\.nc|MonthlyAtmCO2_gcb2024.nc|g" namelist.recom
          sed -i "s|REcoM_restart.*=.*true|REcoM_restart = .false.|g" namelist.recom
          sed -i "s|REcoMDataPath.*=.*'/.*'|REcoMDataPath = './'|g" namelist.recom
          cd ..
          
          # Copy REcoM input data files
          ls -la test/input/recom/
          cp test/input/recom/*.nc work_recom/
          ls -la work_recom/*.nc
      
      - name: FESOM2 REcoM test run
        run: |
          cd work_recom
          ls -ratl
          cat namelist.config
          echo "--- namelist.recom ---"
          cat namelist.recom || echo "namelist.recom not found"
          echo "--- namelist.tra ---"
          cat namelist.tra || echo "namelist.tra not found"
          chmod +x job_docker_new
          ./job_docker_new
      
      - name: Check REcoM results
        run: |-
          cd work_recom
          fcheck .
