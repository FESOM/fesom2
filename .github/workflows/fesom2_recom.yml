
name: "FESOM2: REcoM Biogeochemistry"
# Controls when the action will run. Triggers the workflow on push or pull request.
on:
  workflow_dispatch: {}
  push:
    branches:
      - fesom2.6_recom_tra_diags
  pull_request:
    types:
      - opened
      - synchronize
      - reopened
    branches:
      - main
# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  general_test:
    # Containers must run in Linux based operating systems
    runs-on: ubuntu-latest
    # Docker Hub image that `container-job` executes in
    container: ghcr.io/fesom/fesom2_docker:fesom2_test_refactoring-master

    # Service containers to run with `gfortran_ubuntu`
    steps:
      # NK: this changes working directory to fesom2
      - uses: actions/checkout@v2

      - name: Git safe directory
        run: |
          git config --global --add safe.directory ${PWD}

      - name: Compile model with REcoM
        run: |
          ./configure.sh ubuntu -DRECOM_COUPLED=ON

      - name: Create REcoM test run
        run: |
          mkrun recom test_pi_recom -m docker
      
      - name: Add REcoM namelists and input files
        run: |
          # Copy and patch namelists directly with multiple simple replacements
          cp config/bin_2p1z1d/namelist.recom work_recom/
          cp config/bin_2p1z1d/namelist.tra work_recom/
          
          cd work_recom
          
          # Patch namelist.recom file paths - each on separate line
          sed -i "s|'.*DustClim.*\.nc'|'DustClimMonthlyAlbani_pimesh.nc'|" namelist.recom
          sed -i "s|'.*AeolianNitrogen.*\.nc'|''|" namelist.recom  
          sed -i "s|'.*RiverineInput.*\.nc'|''|" namelist.recom
          sed -i "s|'.*ErosionInput.*\.nc'|''|" namelist.recom
          sed -i "s|'.*MonthlyAtmCO2.*\.nc'|'MonthlyAtmCO2_gcb2024.nc'|" namelist.recom
          sed -i "s|REcoM_restart.*=.*\.true\.|REcoM_restart         =.false.|" namelist.recom
          sed -i "s|REcoMDataPath.*= '.*'|REcoMDataPath         = './'|" namelist.recom
          
          # Patch namelist.tra - replace the whole filelist line
          sed -i "/filelist.*fe_pisces/c\filelist = 'fe5deg.nc', 'oxy5deg.nc', 'si5deg.nc', 'talk5deg.nc', 'tco2_5deg.nc', 'din5deg.nc', 'woa18_netcdf_5deg.nc', 'woa18_netcdf_5deg.nc' ! CI test files" namelist.tra
          
          echo "--- Checking patched namelists ---"
          grep "nm_fe_data_file\|nm_co2_data_file\|REcoM_restart\|REcoMDataPath" namelist.recom
          grep "filelist" namelist.tra | head -1
          cd ..
          
          # Copy REcoM input data files
          ls -la test/input/recom/
          cp test/input/recom/*.nc work_recom/
          ls -la work_recom/*.nc
      
      - name: FESOM2 REcoM test run
        run: |
          cd work_recom
          ls -ratl
          cat namelist.config
          echo "--- namelist.recom ---"
          cat namelist.recom || echo "namelist.recom not found"
          echo "--- namelist.tra ---"
          cat namelist.tra || echo "namelist.tra not found"
          chmod +x job_docker_new
          ./job_docker_new
      
      - name: Check REcoM results
        run: |-
          cd work_recom
          fcheck .
