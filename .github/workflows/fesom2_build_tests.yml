name: FESOM2 Build Tests
# Controls when the action will run. Triggers the workflow on push or pull request.
on:
  workflow_dispatch: {}
  pull_request:
    types:
      - opened
      - synchronize
      - reopened
    branches:
      - add_automated_multiple_builds

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  build_tests:
    # Containers must run in Linux based operating systems
    runs-on: ubuntu-latest
    # Docker Hub image that `container-job` executes in
    container: ghcr.io/suvarchal/fesom2-ci:latest

    # Service containers to run with `gfortran_ubuntu`
    steps:
    # Modern checkout action with v5
    - uses: actions/checkout@v5
      with:
        # Fetch all history for all tags and branches to ensure we have the latest presets
        fetch-depth: 0

    - name: Git safe directory
      run: |
        git config --global --add safe.directory ${PWD}

    - name: List available CMake presets
      run: |
        echo "Available CMake presets:"
        cmake --list-presets
        echo ""
        echo "Available test presets:"
        ctest --list-presets

    - name: Configure and build default configuration
      run: |
        cmake --preset default
        cmake --build --preset default

    - name: Configure and build coupled configuration
      run: |
        cmake --preset coupled
        cmake --build --preset coupled

    - name: Configure and build REcoM3 configuration
      run: |
        cmake --preset recom
        cmake --build --preset recom

    - name: Configure and build IFS interface configuration
      run: |
        cmake --preset ifs_interface
        cmake --build --preset ifs_interface
        
    - name: Verify build artifacts
      run: |
        echo "Checking build artifacts for all configurations:"
        ls -la build/default/
        ls -la build/coupled/
        ls -la build/recom/
        ls -la build/ifs_interface/
        echo ""
        echo "Build completed successfully for all configurations!"
