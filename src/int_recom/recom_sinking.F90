module diff_ver_recom_expl_interface
  interface
    subroutine diff_ver_recom_expl(tr_num, tracer, partit, mesh) 
        use mod_mesh
        USE MOD_PARTIT
        USE MOD_PARSUP
        use mod_tracer
        integer       , intent(in)   , target :: tr_num
        type(t_tracer), intent(inout), target :: tracer
        type(t_partit), intent(inout), target :: partit
        type(t_mesh)  , intent(in)   , target :: mesh
    end subroutine
  end interface
end module
module ver_sinking_recom_interface
  interface
    subroutine ver_sinking_recom(tr_num, tracer, partit, mesh)
        use mod_mesh
        USE MOD_PARTIT
        USE MOD_PARSUP
        use mod_tracer
        integer       , intent(in)   , target :: tr_num
        type(t_tracer), intent(inout), target :: tracer
        type(t_partit), intent(inout), target :: partit
        type(t_mesh)  , intent(in)   , target :: mesh
    end subroutine
  end interface
end module
module ver_sinking_recom_benthos_interface
  interface
    subroutine ver_sinking_recom_benthos(tr_num, tracer, partit, mesh)
        use mod_mesh
        USE MOD_PARTIT
        USE MOD_PARSUP
        use mod_tracer
        integer       , intent(in)   , target :: tr_num
        type(t_tracer), intent(inout), target :: tracer
        type(t_partit), intent(inout), target :: partit
        type(t_mesh)  , intent(in)   , target :: mesh
    end subroutine
  end interface
end module
!===============================================================================
! YY: sinking of second detritus adapted from Ozgur's code
! but not using recom_det_tracer_id, since
! second detritus has a different sinking speed than the first
! define recom_det2_tracer_id to make it consistent???
!===============================================================================
subroutine ver_sinking_recom_benthos(tr_num, tracers, partit, mesh)

    use MOD_MESH
    use MOD_PARTIT
    use MOD_PARSUP
    use MOD_TRACER

    use recom_declarations
    use recom_locvar
    use recom_glovar
    use recom_config
    use recom_ciso
    use ver_sinking_recom_benthos_interface

    use g_support
    use g_clock
    use o_PARAM
    use g_config
    use o_param           ! num_tracers
    use o_arrays
    use g_forcing_arrays  ! press_air
    use g_comm_auto
    implicit none

    integer       , intent(in)   , target :: tr_num
    type(t_tracer), intent(inout), target :: tracers
    type(t_partit), intent(inout), target :: partit
    type(t_mesh)  , intent(in)   , target :: mesh

    integer                   :: elem,k
    integer                   :: nl1,ul1,nz,n,nzmin, nzmax, net
    real(kind=WP)             :: Vben(mesh%nl),  aux(mesh%nl-1),  flux(mesh%nl), add_benthos_2d(partit%myDim_nod2D)
    integer                   :: nlevels_nod2D_minimum
    real(kind=WP)             :: tv
    real(kind=WP), dimension(:,:), pointer :: trarr

#include "../associate_part_def.h"
#include "../associate_mesh_def.h"
#include "../associate_part_ass.h"
#include "../associate_mesh_ass.h"

    trarr=>tracers%data(tr_num)%values(:,:)

   do n=1, myDim_nod2D ! needs exchange_nod in the end
        nl1=nlevels_nod2D(n)-1
        ul1=ulevels_nod2D(n)

        aux=0._WP
        Vben=0._WP
        add_benthos_2d=0._WP

! Calculate sinking velociy for vertical sinking case
! ******************************************************
          if (any(recom_det_tracer_id == tracers%data(tr_num)%ID)) Vben = Vdet
          if (any(recom_phy_tracer_id == tracers%data(tr_num)%ID)) Vben = VPhy
          if (any(recom_dia_tracer_id == tracers%data(tr_num)%ID)) Vben = VDia
        if (allow_var_sinking) then
          Vben = Vdet_a * abs(zbar_3d_n(:,n)) + Vben
        end if

! Constant vertical sinking for the second detritus class
! *******************************************************

#if defined(__3Zoo2Det)
          if(tracers%data(tr_num)%ID==1025 .or. &  !idetz2n
             tracers%data(tr_num)%ID==1026 .or. &  !idetz2c
             tracers%data(tr_num)%ID==1027 .or. &  !idetz2si
             tracers%data(tr_num)%ID==1028 ) then  !idetz2calc
             Vben = VDet_zoo2
          endif
#endif

        Vben= Vben/SecondsPerDay ! conversion [m/d] --> [m/s] (vertical velocity, note that it is positive here)

        k=nod_in_elem2D_num(n)
        ! Screening minimum depth in neigbouring nodes around node n
        nlevels_nod2D_minimum=minval(nlevels(nod_in_elem2D(1:k, n))-1)

        do nz=nlevels_nod2D_minimum, nl1
           tv = trarr(nz,n)*Vben(nz)
           aux(nz)= - tv*(area(nz,n)-area(nz+1,n))
        end do

        do nz=ul1,nl1
           str_bf(nz,n) = str_bf(nz,n) + (aux(nz))*dt/area(nz,n)/(zbar_3d_n(nz,n)-zbar_3d_n(nz+1,n))
           add_benthos_2d(n) = add_benthos_2d(n) - (aux(nz))*dt    !!!!!!!!CHECK Maybe /area(nz,n) -> [mmol/m2]
        end do

        ! Particulate Organic Nitrogen
        if( tracers%data(tr_num)%ID==1004 .or. &  !iphyn
            tracers%data(tr_num)%ID==1007 .or. &  !idetn
            tracers%data(tr_num)%ID==1013 .or. & !) then  !idian
            tracers%data(tr_num)%ID==1025 ) then  !idetz2n
            Benthos(n,1)= Benthos(n,1) +  add_benthos_2d(n) ![mmol]
        endif

        ! Particulate Organic Carbon
        if( tracers%data(tr_num)%ID==1005 .or. &  !iphyc
            tracers%data(tr_num)%ID==1008 .or. &  !idetc
            tracers%data(tr_num)%ID==1014 .or. & !) then  !idiac
            tracers%data(tr_num)%ID==1026 ) then  !idetz2c
            Benthos(n,2)= Benthos(n,2) + add_benthos_2d(n)
        endif

        ! Particulate Organic Silicon
        if( tracers%data(tr_num)%ID==1016 .or. &  !idiasi
            tracers%data(tr_num)%ID==1017 .or. & !) then  !idetsi
            tracers%data(tr_num)%ID==1027 ) then  !idetz2si
            Benthos(n,3)= Benthos(n,3) + add_benthos_2d(n)
        endif

        ! Cal
        if( tracers%data(tr_num)%ID==1020 .or. &  !iphycal
            tracers%data(tr_num)%ID==1021 .or. & !) then  !idetcal
            tracers%data(tr_num)%ID==1028 ) then  !idetz2cal
            Benthos(n,4)= Benthos(n,4) + add_benthos_2d(n)
        endif
   end do
   do n=1, benthos_num
      call exchange_nod(Benthos(:,n), partit)
   end do

end subroutine ver_sinking_recom_benthos
!
!
!===============================================================================
subroutine diff_ver_recom_expl(tr_num, tracers, partit, mesh)
! Remineralization from benthos
! bottom_flux

    use MOD_MESH
    use MOD_PARTIT
    use MOD_PARSUP
    use MOD_TRACER

    use recom_declarations
    use recom_locvar
    use recom_glovar
    use recom_config
    use recom_ciso
    use diff_ver_recom_expl_interface

    use g_clock
    use o_PARAM
    use g_config
    use o_param           ! num_tracers
    use o_arrays
    use g_forcing_arrays  ! press_air
    use g_comm_auto

    IMPLICIT NONE

    integer       , intent(in)   , target :: tr_num
    type(t_tracer), intent(inout), target :: tracers
    type(t_partit), intent(inout), target :: partit
    type(t_mesh)  , intent(in)   , target :: mesh

    integer                  :: elem,k
    integer                  :: n2,nl1,nl2,nz,n,id,ul1
    real(kind=WP)            :: vd_flux(mesh%nl)
    integer                  :: nlevels_nod2D_minimum
    real(kind=WP)            :: bottom_flux(partit%myDim_nod2D+partit%eDim_nod2D)

    real(kind=WP), dimension(:,:), pointer :: trarr

#include "../associate_part_def.h"
#include "../associate_mesh_def.h"
#include "../associate_part_ass.h"
#include "../associate_mesh_ass.h"

    trarr=>tracers%data(tr_num)%values(:,:)


bottom_flux = 0._WP
id = tracers%data(tr_num)%ID

  SELECT CASE (id)
    CASE (1001)
      bottom_flux = GlodecayBenthos(:,1) !*** DIN [mmolN/m^2/s] ***
    CASE (1002)
      bottom_flux = GlodecayBenthos(:,2) + GlodecayBenthos(:,4) !*** DIC + calcification ***
    CASE (1003)
      bottom_flux = GlodecayBenthos(:,4) * 2.0_WP - 1.0625_WP * GlodecayBenthos(:,1) !*** Alk ***
    CASE (1018)
      bottom_flux = GlodecayBenthos(:,3) !*** Si ***
    CASE (1019)
      bottom_flux = GlodecayBenthos(:,1) * Fe2N_benthos !*** DFe ***
    CASE (1022)
      bottom_flux = -GlodecayBenthos(:,2) * redO2C !*** O2 ***
    CASE DEFAULT
      if (partit%mype==0) then
         write(*,*) 'check specified in boundary conditions'
         write(*,*) 'the model will stop!'
      end if
      call par_ex(partit%MPI_COMM_FESOM, partit%mype)
      stop
  END SELECT

   do n=1, myDim_nod2D

        nl1=nlevels_nod2D(n)-1
        ul1=ulevels_nod2D(n)

        vd_flux=0._WP

        k=nod_in_elem2D_num(n)
        ! Screening minimum depth in neigbouring nodes around node n
        nlevels_nod2D_minimum=minval(nlevels(nod_in_elem2D(1:k, n))-1)

        !_______________________________________________________________________
        ! Bottom flux
        do nz=nlevels_nod2D_minimum, nl1
            vd_flux(nz)=(area(nz,n)-area(nz+1,n))* bottom_flux(n)/(area(1,n))  !!!!!!!!
        end do
        nz=nl1
        vd_flux(nz+1)= (area(nz+1,n))* bottom_flux(n)/(area(1,n))
        !_______________________________________________________________________
        ! writing flux into rhs
        do nz=ul1,nl1
            ! flux contribute only the cell through its bottom !!!
!            dtr_bf(nz,n) = dtr_bf(nz,n) + vd_flux(nz+1)*dt/area(nz,n)/(zbar_3d_n(nz,n)-zbar_3d_n(nz+1,n))
            dtr_bf(nz,n) = dtr_bf(nz,n) + vd_flux(nz+1)*dt/areasvol(nz,n)/hnode_new(nz,n)
        end do
    end do
end subroutine diff_ver_recom_expl

subroutine ver_sinking_recom(tr_num, tracers, partit, mesh)
! Sinking in water column

    use MOD_MESH
    use MOD_PARTIT
    use MOD_PARSUP
    use MOD_TRACER

    use REcoM_declarations
    use REcoM_LocVar
    use REcoM_GloVar
    use recom_config
    use REcoM_ciso
    use ver_sinking_recom_interface

    use g_clock
    use o_PARAM
    use g_config
    use o_param           ! num_tracers
    use o_arrays
    use g_forcing_arrays  ! press_air
    use g_comm_auto
    implicit none

    integer       , intent(in)   , target  :: tr_num
    type(t_tracer), intent(inout), target  :: tracers
    type(t_partit), intent(inout), target  :: partit
    type(t_mesh)  , intent(in)   , target  :: mesh

    integer                                :: node, nz,  id, nzmin, nzmax, n, k, nlevels_nod2D_minimum
    real(kind=WP)                          :: vd_flux(mesh%nl)
    real(kind=8)                           :: dz_trr(mesh%nl), aux
    real(kind=8)                           :: wLoc,wM,wPs
    real(kind=8)                           :: Rjp,Rj,Rjm

    real(kind=8)                           :: cfl, d0, d1, thetaP, thetaM, psiP, psiM
    real(kind=8)                           :: onesixth	= 	1.d0/6.d0
    real(kind=8)                           :: dt_sink, c1, c2     ! BALL added dt_sink
    real(kind=8)                           :: Vsink, tv
    real(kind=8),dimension(mesh%nl)        :: Wvel_flux

    real(kind=WP), dimension(:,:), pointer :: trarr

#include "../associate_part_def.h"
#include "../associate_mesh_def.h"
#include "../associate_part_ass.h"
#include "../associate_mesh_ass.h"

    trarr=>tracers%data(tr_num)%values(:,:)

!< calculate scaling factors
!< scaling_density1_3D, scaling_density2_3D
!< scaling_visc_3D
!< .OG. 04.11.2022

!< Constant sinking velocities (we prescribe them under namelist recom)
!< This hardcoded part is temporary
!< .OG. 07.07.2021

    Vsink=0.0_WP

    if (tracers%data(tr_num)%ID ==1007 .or.    &  !idetn
        tracers%data(tr_num)%ID ==1008 .or.    &  !idetc
        tracers%data(tr_num)%ID ==1017 .or.    &  !idetsi
        tracers%data(tr_num)%ID ==1021 ) then     !idetcal

            Vsink = VDet

    elseif(tracers%data(tr_num)%ID ==1004 .or. &  !iphyn
        tracers%data(tr_num)%ID ==1005 .or.    &  !iphyc
        !tracers%data(tr_num)%ID==1020 .or.    &  !iphycal
        tracers%data(tr_num)%ID==1006 ) then     !ipchl

            Vsink = VPhy

    elseif(tracers%data(tr_num)%ID==1013 .or. &  !idian
        tracers%data(tr_num)%ID==1014 .or.    &  !idiac
        tracers%data(tr_num)%ID==1016 .or.    &  !idiasi
        tracers%data(tr_num)%ID==1015 ) then     !idchl

            Vsink = VDia

#if defined (__coccos)
    elseif(tracers%data(tr_num)%ID == 1029 .or. &  !icocn             ! NEW
        tracers%data(tr_num)%ID == 1030 .or.    &  !icocc             ! NEW
        tracers%data(tr_num)%ID == 1031 ) then     !icchl             ! NEW

            Vsink = VCocco
#endif

    elseif(tracers%data(tr_num)%ID == 1020) then   !iphycal
       
#if defined (__coccos)
            Vsink = VCocco
#else
            Vsink = VPhy
#endif
            
#if defined (__3Zoo2Det)
    elseif(tracers%data(tr_num)%ID==1025 .or. &  !idetz2n
         tracers%data(tr_num)%ID==1026 .or. &  !idetz2c
         tracers%data(tr_num)%ID==1027 .or. &  !idetz2si
         tracers%data(tr_num)%ID==1028 ) then  !idetz2calc 
            
            Vsink = VDet_zoo2
#endif
    end if

if (Vsink .gt. 0.1) then ! No sinking if Vsink < 0.1 m/day

   do n = 1,myDim_nod2D
      if (ulevels_nod2D(n)>1) cycle
      nzmin = ulevels_nod2D(n)
      nzmax = nlevels_nod2D(n)-1

      ! distance between tracer points, surface and bottom dz_trr is half
      ! the layer thickness
      dz_trr                = 0.0d0
      dz_trr(nzmin+1:nzmax) = abs(Z_3d_n(nzmin:nzmax-1,n)-Z_3d_n(nzmin+1:nzmax,n))
      dz_trr(nzmin)         = hnode(nzmin,n)/2.0d0
      dz_trr(nzmax+1)       = hnode(nzmax,n)/2.0d0

      Wvel_flux(nzmin:nzmax+1)= 0.d0  ! Vertical velocity for BCG tracers

      do nz=nzmin,nzmax+1

         Wvel_flux(nz) = -Vsink/SecondsPerDay ! allow_var_sinking = .false.

         if (allow_var_sinking) then
               Wvel_flux(nz) = -((Vdet_a * abs(zbar_3d_n(nz,n))/SecondsPerDay) + Vsink/SecondsPerDay)
         end if

#if defined (__3Zoo2Det)
            ! We assume constant sinking for second detritus
            if(tracers%data(tr_num)%ID ==1025 .or. &  !idetz2n
               tracers%data(tr_num)%ID ==1026 .or. &  !idetz2c
               tracers%data(tr_num)%ID ==1027 .or. &  !idetz2si
               tracers%data(tr_num)%ID ==1028 ) then  !idetz2calc
                  Wvel_flux(nz) = -VDet_zoo2/SecondsPerDay ! --> VDet_zoo2 ! NEW BALL changed -Vsink to -VDet_zoo2
            endif ! second detritus tracers
#endif
      end do

      dt_sink = dt
      vd_flux = 0.0d0

if (1) then ! 3rd Order DST Sceheme with flux limiting. This code comes from old recom

      k=nod_in_elem2D_num(n)
      ! Screening minimum depth in neigbouring nodes around node n
      nlevels_nod2D_minimum=minval(nlevels(nod_in_elem2D(1:k, n))-1)

      vd_flux(nzmin:nzmax+1)= 0.0_WP

      do nz=nzmax, nzmin+1,-1

         Rjp = trarr(nz,n)              - trarr(min(nz+1,nzmax),n)
         Rj  = trarr(max(nzmin,nz-1),n) - trarr(nz,n)
         Rjm = trarr(max(nzmin,nz-2),n) - trarr(max(nzmin,nz-1),n)

         cfl = abs(Wvel_flux(nz) * dt_sink / dz_trr(nz)) !(Z_n(nz-1)-Z_n(nz)))       ! [m/day] * [day] * [1/m]  ! NEW BALL changed dt to dt_sink

         wPs = Wvel_flux(nz) + abs(Wvel_flux(nz)) ! --> Positive vertical velocity
         wM  = Wvel_flux(nz) - abs(Wvel_flux(nz)) ! --> Negative vertical velocity

         d0 = (2.d0 - cfl)*(1.d0 - cfl)*onesixth
         d1 = (1.d0 - cfl*cfl)*onesixth

         thetaP = Rjm/(1.d-20+Rj)
         psiP = d0 + d1*thetaP
         psiP = max(0.d0, min(min(1.d0,psiP), &
            (1.d0-cfl)/(1.d-20+cfl)*thetaP))

         thetaM = Rjp/(1.d-20 + Rj)
         psiM = d0 + d1*thetaM
         psiM = max(0.d0, min(min(1.d0,psiM), &
            (1.d0-cfl)/(1.d-20-cfl)*thetaM))

         tv= (0.5 * wPs * (trarr(nz,n)              + psiM * Rj)+ &
	      0.5 * wM  * (trarr(max(nzmin,nz-1),n) + psiP * Rj))
         vd_flux(nz)= - tv*area(nz,n)
      end do
end if ! 3rd Order DST Sceheme with flux limiting

if (0) then ! simple upwind

      ! Surface flux
      vd_flux(nzmin)= 0.0_WP

      ! Bottom flux
      vd_flux(nzmax+1)= 0.0_WP

      k=nod_in_elem2D_num(n)
      ! Screening minimum depth in neigbouring nodes around node n
      nlevels_nod2D_minimum=minval(nlevels(nod_in_elem2D(1:k, n))-1)

      do nz=nzmin+1,nzmax !nlevels_nod2D_minimum-1
!         tv = trarr(nz,n)                                ! simple scheme       - test1
!         tv = 0.5_WP*(trarr(nz-1,n)+trarr(nz,n))        ! consider both layers - test2
!         tv = tv*Wvel_flux(nz) ! Wvel_flux is negative
         tv = - 0.5* & ! - test3
            (trarr(nz-1,n)*(Wvel_flux(nz)-abs(Wvel_flux(nz))) + &
             trarr(nz  ,n)*(Wvel_flux(nz)+abs(Wvel_flux(nz))))
         vd_flux(nz)= tv*area(nz,n)

      end do
end if ! simple upwind
      do nz=nzmin,nzmax
         vert_sink(nz,n) = vert_sink(nz,n) + (vd_flux(nz)-vd_flux(nz+1))*dt/areasvol(nz,n)/hnode_new(nz,n) !/(zbar_3d_n(nz,n)-zbar_3d_n(nz+1,n))
      end do
   end do
end if ! Vsink .gt. 0.1

end subroutine ver_sinking_recom

